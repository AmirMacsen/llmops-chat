# LLMOps 项目 API 文档


## 一、通用规范
### 1.1 响应格式
所有接口统一以 **JSON 格式**返回，固定包含 3 个字段：

| 字段名   | 类型   | 说明                     |
|----------|--------|--------------------------|
| `code`   | string | 业务状态码（见 1.2 说明） |
| `data`   | object | 业务数据（成功时返回，失败时可能为空） |
| `message`| string | 接口附加信息（失败时返回错误详情，成功时为空） |


### 1.2 业务状态码
共 6 种状态码，仅 `success` 代表成功，其余均为失败：

| 状态码          | 说明                     |
|-----------------|--------------------------|
| `success`       | 业务操作成功             |
| `fail`          | 通用失败（未明确分类的错误） |
| `not_found`     | 资源未找到（如应用 ID 不存在） |
| `unauthorized`  | 未授权（缺少或无效的令牌） |
| `forbidden`     | 无权限（令牌有效但无操作权限） |
| `validate_error`| 数据验证失败（如参数格式错误） |


### 1.3 分页数据格式
带有分页功能的接口，`data` 字段内固定包含 `list` 和 `paginator` 两个子字段：

| 字段名       | 类型   | 说明                     |
|--------------|--------|--------------------------|
| `list`       | array  | 分页后的列表数据（具体结构随接口变化） |
| `paginator`  | object | 分页元数据（固定包含以下 4 个字段） |

`paginator` 字段结构：
| 子字段名       | 类型   | 说明                     |
|----------------|--------|--------------------------|
| `current_page` | int    | 当前页数（从 1 开始）    |
| `page_size`    | int    | 每页数据条数（默认 20）  |
| `total_page`   | int    | 总页数                   |
| `total_record` | int    | 总记录条数               |


### 1.4 授权方式
需要授权的接口（文档中标注“授权+”），需在 HTTP 请求头 `headers` 中添加 `Authorization` 字段，格式如下：
```http
Authorization: Bearer {access_token}
```
示例：
```http
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MTY0NTY3OTgsImlzcyI6ImxsbW9wcyIsInN1YiI6ImM5MDljMWRiLWIyMmUtNGZlNi04OGIyLWIyZTkxZWFiMWE3YiJ9.JDAtWDBBGiXa_XFihfopRe4Cz-RQ9_TAcno9w81tNbE
```


## 二、应用模块接口
### 2.1 [todo] 获取应用基础信息
#### 接口说明
传递对应的应用 ID，获取当前应用的基础信息（名称、图标等）+ 配置信息（草稿/已发布配置）。

#### 接口信息
- 授权：需要
- HTTP 方法：GET
- 接口路径：`/apps/:app_id`

#### 请求参数
| 参数名   | 位置   | 类型   | 是否必填 | 说明                     |
|----------|--------|--------|----------|--------------------------|
| `app_id` | 路由参数 | uuid   | 是       | 需要获取信息的应用 ID    |

#### 响应参数
| 参数名                  | 类型   | 说明                                                                 |
|-------------------------|--------|----------------------------------------------------------------------|
| `id`                    | uuid   | 应用 ID                                                               |
| `name`                  | string | 应用名称                                                             |
| `icon`                  | string | 应用图标（URL 地址）                                                 |
| `description`           | string | 应用描述                                                             |
| `published_app_config_id` | uuid | 已发布应用配置 ID（若不存在则为 `null`）                             |
| `drafted_app_config_id`  | uuid | 草稿应用配置 ID（若不存在则为 `null`）                               |
| `debug_conversation_id`  | uuid | 调试会话记录 ID（若不存在则为 `null`）                               |
| `published_app_config`   | object | 已发布应用配置（结构见下文，若不存在则为 `null`）                   |
| `drafted_app_config`     | object | 草稿应用配置（结构见下文，若不存在则为 `null`）                     |
| `updated_at`            | int    | 应用更新时间（时间戳，单位：秒）                                     |
| `created_at`            | int    | 应用创建时间（时间戳，单位：秒）                                     |

**`published_app_config`/`drafted_app_config` 配置结构**：
| 子参数名       | 类型   | 说明                                                                 |
|----------------|--------|----------------------------------------------------------------------|
| `id`           | uuid   | 应用配置 ID                                                           |
| `model_config` | object | 模型配置（包含 `dialog_round` 等子字段）                             |
| `dialog_round` | int    | 携带上下文轮数（非负整型）                                           |
| `memory_mode`  | string | 记忆类型，可选值：`long_term_memory`（长记忆）、`none`（无记忆）      |
| `status`       | string | 配置状态，可选值：`drafted`（草稿）、`published`（已发布）            |
| `updated_at`   | int    | 配置更新时间（时间戳，单位：秒）                                     |
| `created_at`   | int    | 配置创建时间（时间戳，单位：秒）                                     |

#### 响应示例
```json
{
    "code": "success",
    "data": {
        "id": "5e7834dc-bbca-4ee5-9591-8f297f5acded",
        "name": "LLMOps聊天机器人",
        "icon": "https://imooc-llmops-1257184990.cos.ap-guangzhou.myqcloud.com/2024/04/23/e4422149-4cf7-41b3-ad55-ca8d2caa8f13.png",
        "description": "这是一个LLMOps的Agent应用",
        "published_app_config_id": null,
        "drafted_app_config_id": null,
        "debug_conversation_id": "1550b71a-1444-47ed-a59d-c2f080fbae94",
        "published_app_config": null,
        "drafted_app_config": {
            "id": "755dc464-67cd-42ef-9c56-b7528b44e7c8",
            "model_config": {
                "dialog_round": 3
            },
            "memory_mode": "long_term_memory",
            "status": "draft",
            "updated_at": 1714053834,
            "created_at": 1714053834
        },
        "updated_at": 1714053834,
        "created_at": 1714053834
    },
    "message": ""
}
```


### 2.2 [todo] 更新应用草稿配置信息
#### 接口说明
更新应用的草稿配置信息（含模型配置、长记忆模式等）：  
- 若应用已有原始草稿配置，直接更新；  
- 若没有原始草稿配置，创建新配置作为草稿。

#### 接口信息
- 授权：需要
- HTTP 方法：POST
- 接口路径：`/apps/:app_id/config`

#### 请求参数
| 参数名         | 位置   | 类型   | 是否必填 | 说明                     |
|----------------|--------|--------|----------|--------------------------|
| `app_id`       | 路由参数 | str    | 是       | 需要修改配置的应用 ID    |
| `model_config` | 请求体 | object | 是       | 模型配置信息（含 `dialog_round` 子字段） |
| `dialog_round` | 请求体 | int    | 是       | 携带上下文轮数（非负整型） |
| `memory_mode`  | 请求体 | string | 是       | 记忆类型，可选值：`long_term_memory`（长记忆）、`none`（无记忆） |

#### 请求示例
```json
{
    "model_config": {
        "dialog_round": 10
    },
    "memory_mode": "long_term_memory"
}
```

#### 响应示例
```json
{
    "code": "success",
    "data": {},
    "message": "更新AI应用配置成功"
}
```


### 2.3 [todo] 获取应用调试长记忆
#### 接口说明
获取指定应用的长记忆内容；**若应用未开启长记忆（`memory_mode` 为 `none`），调用会抛出错误**。

#### 接口信息
- 授权：需要
- HTTP 方法：GET
- 接口路径：`/apps/:app_id/long-term-memory`

#### 请求参数
| 参数名   | 位置   | 类型   | 是否必填 | 说明                     |
|----------|--------|--------|----------|--------------------------|
| `app_id` | 路由参数 | str    | 是       | 需要获取长记忆的应用 ID  |

#### 响应参数
| 参数名   | 类型   | 说明                     |
|----------|--------|--------------------------|
| `summary`| string | 应用最新调试会话的长记忆内容 |

#### 响应示例
```json
{
    "code": "success",
    "data": {
        "summary": "人类自我介绍为慕小课，并要求人工智能解释LLM（大型语言模型）的概念。人工智能将LLM描述为一种基于深度学习的模型，通常建立在Transformer架构上，用于自然语言处理任务。LLM经历了一个预训练阶段，在那里他们从大量的文本数据中学习语言结构，比如维基百科的文章和书籍。它们利用自我注意机制来有效地处理长程依赖关系。经过预训练后，LLM可以针对特定的应用程序进行微调，使其功能适应文本生成、理解和分类等任务。LLM由于其多功能性和强大的语言理解和生成能力，被广泛应用于虚拟助理、翻译、情绪分析、医疗保健、金融等领域，代表了自然语言处理的前沿技术。"
    },
    "message": ""
}
```


### 2.4 [todo] 更新应用调试长记忆
#### 接口说明
更新指定应用的调试长记忆内容；**若应用未开启长记忆（`memory_mode` 为 `none`），调用会抛出错误**。

#### 接口信息
- 授权：需要
- HTTP 方法：POST
- 接口路径：`/apps/:app_id/long-term-memory`

#### 请求参数
| 参数名   | 位置   | 类型   | 是否必填 | 说明                     |
|----------|--------|--------|----------|--------------------------|
| `app_id` | 路由参数 | str    | 是       | 需要更新长记忆的应用 ID  |
| `summary`| 请求体 | string | 是       | 待更新的长记忆内容       |

#### 请求示例
```json
{
    "summary": "人类介绍自己叫慕小课，喜欢打篮球。"
}
```

#### 响应示例
```json
{
    "code": "success",
    "data": {},
    "message": "更新AI应用长记忆成功"
}
```


### 2.5 [todo] 应用调试对话
#### 接口说明
在编排 AI 应用时进行 debug 调试，配置优先级：  
- 若应用有草稿配置，使用草稿配置调试；  
- 若没有草稿配置，使用已发布配置调试。

#### 接口信息
- 授权：需要
- HTTP 方法：POST
- 接口路径：`/apps/:app_id/debug`

#### 请求参数
| 参数名   | 位置   | 类型   | 是否必填 | 说明                     |
|----------|--------|--------|----------|--------------------------|
| `app_id` | 路由参数 | uuid   | 是       | 需要调试的应用 ID        |
| `query`  | 请求体 | string | 是       | 用户发起的提问内容       |

#### 请求示例
```json
{
    "query": "能详细讲解下LLM是什么吗？"
}
```

#### 响应参数
| 参数名              | 类型   | 说明                     |
|---------------------|--------|--------------------------|
| `id`                | uuid   | 响应消息 ID              |
| `conversation_id`    | uuid   | 消息关联的会话 ID        |
| `query`              | string | 用户输入的提问内容       |
| `answer`             | string | AI 生成的回答内容        |
| `answer_tokens`      | int    | 生成回答消耗的 Token 数  |
| `response_latency`   | float  | 响应耗时（单位：毫秒）   |
| `updated_at`         | int    | 消息更新时间（时间戳，秒）|
| `created_at`         | int    | 消息创建时间（时间戳，秒）|

#### 响应示例
```json
{
    "code": "success",
    "data": {
        "id": "1550b71a-1444-47ed-a59d-c2f080fbae94",
        "conversation_id": "2d7d3e3f-95c9-4d9d-ba9c-9daaf09cc8a8",
        "query": "能详细讲解下LLM是什么吗？",
        "answer": "LLM 即 Large Language Model，大语言模型，是一种基于深度学习的自然语言处理模型，具有很高的语言理解和生成能力，能够处理各式各样的自然语言任务，例如文本生成、问答、翻译、摘要等。它通过在大量的文本数据上进行训练，学习到语言的模式、结构和语义知识。",
        "answer_tokens": 1454,
        "response_latency": 8541,
        "updated_at": 1714053834,
        "created_at": 1714053834
    },
    "message": ""
}
```


### 2.6 [todo] 获取应用调试历史对话列表
#### 接口说明
获取应用调试历史对话列表，支持分页：  
- 单次最多返回 20 组对话消息；  
- 分页按时间字段（`created_at`）降序排列；  
- 不返回软删除的数据。

#### 接口信息
- 授权：需要
- HTTP 方法：GET
- 接口路径：`/apps/:app_id/messages`

#### 请求参数
| 参数名   | 位置   | 类型   | 是否必填 | 说明                     |
|----------|--------|--------|----------|--------------------------|
| `app_id` | 路由参数 | uuid   | 是       | 需要获取历史的应用 ID    |

#### 响应参数
- 整体结构符合“分页数据格式”（含 `list` 和 `paginator`）；  
- `list` 中每个元素的结构与“2.5 应用调试对话”的响应参数一致（`id`、`conversation_id` 等）。

#### 响应示例
```json
{
    "code": "success",
    "data": {
        "list": [
            {
                "id": "1550b71a-1444-47ed-a59d-c2f080fbae94",
                "conversation_id": "2d7d3e3f-95c9-4d9d-ba9c-9daaf09cc8a8",
                "query": "能详细讲解下LLM是什么吗？",
                "answer": "LLM 即 Large Language Model，大语言模型，是一种基于深度学习的自然语言处理模型，具有很高的语言理解和生成能力，能够处理各式各样的自然语言任务，例如文本生成、问答、翻译、摘要等。它通过在大量的文本数据上进行训练，学习到语言的模式、结构和语义知识。",
                "answer_tokens": 1454,
                "response_latency": 8541,
                "updated_at": 1714053834,
                "created_at": 1714053834
            }
        ],
        "paginator": {
            "current_page": 1,
            "page_size": 20,
            "total_page": 1,
            "total_record": 2
        }
    },
    "message": ""
}
```


### 2.7 [todo] 删除特定的调试消息
#### 接口说明
删除 AI 应用调试对话中的指定消息，规则：  
- 后端执行 **软删除** 操作；  
- 仅当“会话 ID（`conversation_id`）”和“消息 ID（`message_id`）”均匹配时，才会删除对应的消息。

#### 接口信息
- 授权：需要
- HTTP 方法：POST
- 接口路径：`/apps/:app_id/messages/:message_id/delete`

#### 请求参数
| 参数名         | 位置   | 类型   | 是否必填 | 说明                     |
|----------------|--------|--------|----------|--------------------------|
| `app_id`       | 路由参数 | uuid   | 是       | 消息所属的应用 ID        |
| `message_id`   | 路由参数 | uuid   | 是       | 需要删除的消息 ID        |

#### 请求示例
```json
{
    "app_id": "1550b71a-1444-47ed-a59d-c2f080fbae94",
    "message_id": "2d7d3e3f-95c9-4d9d-ba9c-9daaf09cc8a8"
}
```

#### 响应示例
```json
{
    "code": "success",
    "data": {},
    "message": "删除调试信息成功"
}
```